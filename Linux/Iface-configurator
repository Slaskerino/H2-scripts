#!/bin/bash

set -e

echo "==> Multi Iface opdator (Netplan)"

# Get all non-loopback interfaces
AVAILABLE_INTERFACES=($(ls /sys/class/net | grep -v lo))



if [ "${#AVAILABLE_INTERFACES[@]}" -eq 0 ]; then
    echo "Ingen interfaces blev fundet. stopper script"
    exit 1
fi

# Locate Netplan config
NETPLAN_FILE=$(find /etc/netplan -name "*.yaml" | head -n 1)
if [ -z "$NETPLAN_FILE" ]; then
    echo "ingen Netplan fil blev fundet under /etc/netplan. script stopper"
    exit 1
fi

echo "==> Backup af eksisterende Netplan konfig: $NETPLAN_FILE"
sudo cp "$NETPLAN_FILE" "${NETPLAN_FILE}.bak.$(date +%F-%T)"

CONFIG=$(cat <<EOF
network:
  version: 2
  renderer: networkd
  ethernets:
EOF
)

USED_INTERFACES=()

while true; do
    echo
    echo "Tilgængelige interfaces:"
    for i in "${!AVAILABLE_INTERFACES[@]}"; do
        echo "$((i+1)). ${AVAILABLE_INTERFACES[$i]}"
    done

    read -p "Vælg et interface ud fra nummer (Eller tryk ENTER for at forlade scriptet): " CHOICE

    if [[ -z "$CHOICE" ]]; then
        break
    fi

    if ! [[ "$CHOICE" =~ ^[0-9]+$ ]] || (( CHOICE < 1 || CHOICE > ${#AVAILABLE_INTERFACES[@]} )); then
        echo "Forkert data, prøv igen."
        continue
    fi

    IFACE="${AVAILABLE_INTERFACES[$((CHOICE-1))]}"

    # Prevent reuse
    if [[ " ${USED_INTERFACES[*]} " == *" $IFACE "* ]]; then
        echo "Interface $IFACE har allerede en konfiguration. Den kan opdateres manuelt under $NETPLAN_FILE. Vælg et andet interface eller forlad scriptet."
        continue
    fi

    USED_INTERFACES+=("$IFACE")

    read -p "Brug DHCP på $IFACE? (ja/nej): " USE_DHCP
    if [[ "$USE_DHCP" =~ ^[Jj] ]]; then
        CONFIG+="
    $IFACE:
      dhcp4: true"
    else
        read -p "Indtast en statisk IP for $IFACE, efterfuldt af prefix. (f.eks: 192.168.1.50/24): " STATIC_IP
        read -p "Indtast gateway for $IFACE (Eller efterlad den tom for ingen): " GATEWAY
        read -p "Indtast DNS servere opdelt med kommaer (8.8.8.8, 9.9.9.9): " DNS

        CONFIG+="
    $IFACE:
      dhcp4: no
      addresses:
        - $STATIC_IP"

        if [[ -n "$GATEWAY" ]]; then
            CONFIG+="
      gateway4: $GATEWAY"
        fi

        if [[ -n "$DNS" ]]; then
            CONFIG+="
      nameservers:
        addresses: [${DNS//,/ }]"
        fi
    fi
done

# Hvis der ikke er valgt et interface
if [ "${#USED_INTERFACES[@]}" -eq 0 ]; then
    echo "⚠️ No interfaces selected. Exiting."
    exit 1
fi

# Skriv ny config til fil
echo "==> Writing new Netplan configuration to $NETPLAN_FILE..."
echo "$CONFIG" | sudo tee "$NETPLAN_FILE" > /dev/null

# commit konfigurationen til netplan
echo
read -p "Do you want to apply the configuration now? (yes/no): " APPLY_NOW
if [[ "$APPLY_NOW" =~ ^[Yy] ]]; then
    echo "==> Tilføjer ny netplan konfig..."
    sudo netplan apply
    echo "Netplan konfiguration tilføjet."
else
    echo "Netplan konfiguration blev ikke tilføjet. Brug 'sudo netplan apply' for manuelt at tilføje ændringerne."
fi
